# Copyright 2025 Clidey, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:
  # e2e_sqlite3:
  #   image: nouchka/sqlite3:latest
  #   container_name: e2e_sqlite3
  #   volumes:
  #     - e2e_sqlite3:/root/db
  #     - ./sample-data/sqlite3/data.sql:/docker-entrypoint-initdb.d/init.sql
  #   entrypoint: >
  #     sh -c "
  #     sqlite3 /root/db/e2e_test.db < /docker-entrypoint-initdb.d/init.sql &&
  #     echo 'SQLite3 Started...' &&
  #     tail -f /dev/null
  #     "

  e2e_postgres:
    image: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: jio53$*(@nfe)
      PGDATA: /data/postgres
      POSTGRES_DB: test_db
    volumes:
      - e2e_postgres:/data/postgres
      - ./sample-data/postgres/data.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - db

  e2e_mysql:
    image: mysql
    environment:
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: test_db
      MYSQL_ROOT_PASSWORD: password
    volumes:
      - e2e_mysql:/var/lib/mysql
      - ./sample-data/mysql/data.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - db

  e2e_mysql_842:
    image: mysql:8.4.2
    environment:
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: test_db_842
      MYSQL_ROOT_PASSWORD: password
    volumes:
      - e2e_mysql_842:/var/lib/mysql
      - ./sample-data/mysql/data842.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3308:3306"
    networks:
      - db

  e2e_mariadb:
    image: mariadb
    environment:
      MARIADB_USER: user
      MARIADB_PASSWORD: password
      MARIADB_DATABASE: test_db
      MARIADB_ROOT_PASSWORD: password
    volumes:
      - e2e_mariadb:/var/lib/mysql
      - ./sample-data/mariadb/data.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3307:3306"
    networks:
      - db

  e2e_mongo:
    image: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: test_db
    volumes:
      - e2e_mongo:/data/db
      - ./sample-data/mongo/data.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    ports:
      - "27017:27017"
    networks:
      - db

  e2e_clickhouse:
    image: clickhouse/clickhouse-server
    user: clickhouse:clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_USER: user
      CLICKHOUSE_PASSWORD: password
      CLICKHOUSE_DB: test_db
      CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS: "true"
    volumes:
      - e2e_clickhouse:/var/lib/clickhouse
      - ./sample-data/clickhouse/data.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - db

  e2e_redis:
    image: redis:latest
    container_name: e2e_redis
    ports:
      - "6379:6379"
    volumes:
      - e2e_redis:/data
    networks:
      - db
    command: redis-server --requirepass password

  redis-init:
    image: redis:latest
    depends_on:
      - e2e_redis
    volumes:
      - ./sample-data/redis/init.sh:/init.sh
    entrypoint: >
      sh -c "
        chmod +x /init.sh &&
        /init.sh
      "
    networks:
      - db

  # todo: this version is old, need to look into upgrading to a newer
  e2e_elasticsearch:
    image: elasticsearch:8.11.1
    container_name: e2e_elasticsearch
    platform: linux/amd64
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
      # Disable disk watermark for dev environments with limited disk space
      - cluster.routing.allocation.disk.threshold_enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - e2e_elasticsearch:/usr/share/elasticsearch/data
    networks:
      - db
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  elasticsearch-init:
    image: curlimages/curl:latest
    depends_on:
      e2e_elasticsearch:
        condition: service_healthy
    volumes:
      - ./sample-data/elasticsearch/upload.sh:/upload.sh:ro
    entrypoint: ["/bin/sh", "-c", "sh /upload.sh"]
    networks:
      - db

#  e2e_elasticsearch_922:
#    image: elasticsearch:9.2.2
#    container_name: e2e_elasticsearch_922
#    platform: linux/amd64
#    environment:
#      - discovery.type=single-node
#      - xpack.security.enabled=false
#      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
#      - bootstrap.memory_lock=true
#    ulimits:
#      memlock:
#        soft: -1
#        hard: -1
#    ports:
#      - "9201:9200"
#      - "9301:9300"
#    volumes:
#      - e2e_elasticsearch_922:/usr/share/elasticsearch/data
#    networks:
#      - db
#    healthcheck:
#      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health || exit 1"]
#      interval: 30s
#      timeout: 10s
#      retries: 5
#
#  elasticsearch-init-922:
#    image: curlimages/curl:latest
#    depends_on:
#      e2e_elasticsearch_922:
#        condition: service_healthy
#    volumes:
#      - ./sample-data/elasticsearch/upload922.sh:/upload.sh:ro
#    entrypoint: ["/bin/sh", "-c", "sh /upload.sh"]
#    networks:
#      - db


  # SSL-enabled PostgreSQL for SSL E2E tests
  e2e_postgres_ssl:
    profiles: ["ssl"]
    image: postgres
    container_name: e2e_postgres_ssl
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: jio53$*(@nfe)
      POSTGRES_DB: test_db
      PGDATA: /data/postgres
    volumes:
      - e2e_postgres_ssl:/data/postgres
      - ./sample-data/postgres/data.sql:/docker-entrypoint-initdb.d/init.sql
      - ./certs/server/postgres/server-cert.pem:/certs-src/server-cert.pem:ro
      - ./certs/server/postgres/server-key.pem:/certs-src/server-key.pem:ro
      - ./certs/ca/postgres/ca.pem:/certs-src/ca.pem:ro
    command: >
      bash -c "
        mkdir -p /certs &&
        cp /certs-src/* /certs/ &&
        chown postgres:postgres /certs/* &&
        chmod 600 /certs/server-key.pem &&
        chmod 644 /certs/server-cert.pem /certs/ca.pem &&
        exec docker-entrypoint.sh postgres -c ssl=on -c ssl_cert_file=/certs/server-cert.pem -c ssl_key_file=/certs/server-key.pem -c ssl_ca_file=/certs/ca.pem
      "
    ports:
      - "5433:5432"
    networks:
      - db

  # SSL-enabled MySQL for SSL E2E tests
  e2e_mysql_ssl:
    profiles: ["ssl"]
    image: mysql
    container_name: e2e_mysql_ssl
    environment:
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: test_db
      MYSQL_ROOT_PASSWORD: password
    volumes:
      - e2e_mysql_ssl:/var/lib/mysql
      - ./sample-data/mysql/data.sql:/docker-entrypoint-initdb.d/init.sql
      - ./certs/ca/mysql/ca.pem:/etc/mysql/certs/ca.pem:ro
      - ./certs/server/mysql/server-cert.pem:/etc/mysql/certs/server-cert.pem:ro
      - ./certs/server/mysql/server-key.pem:/etc/mysql/certs/server-key.pem:ro
      - ./conf/mysql_ssl.cnf:/etc/mysql/conf.d/ssl.cnf:ro
    ports:
      - "3309:3306"
    networks:
      - db

  # SSL-enabled MariaDB for SSL E2E tests
  e2e_mariadb_ssl:
    profiles: ["ssl"]
    image: mariadb
    container_name: e2e_mariadb_ssl
    environment:
      MARIADB_USER: user
      MARIADB_PASSWORD: password
      MARIADB_DATABASE: test_db
      MARIADB_ROOT_PASSWORD: password
    volumes:
      - e2e_mariadb_ssl:/var/lib/mysql
      - ./sample-data/mariadb/data.sql:/docker-entrypoint-initdb.d/init.sql
      - ./certs/ca/mariadb/ca.pem:/etc/mysql/certs/ca.pem:ro
      - ./certs/server/mariadb/server-cert.pem:/etc/mysql/certs/server-cert.pem:ro
      - ./certs/server/mariadb/server-key.pem:/etc/mysql/certs/server-key.pem:ro
      - ./conf/mariadb_ssl.cnf:/etc/mysql/conf.d/ssl.cnf:ro
    ports:
      - "3310:3306"
    networks:
      - db

  # SSL-enabled MongoDB for SSL E2E tests
  e2e_mongo_ssl:
    profiles: ["ssl"]
    image: mongo
    container_name: e2e_mongo_ssl
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: test_db
    volumes:
      - e2e_mongo_ssl:/data/db
      - ./sample-data/mongo/data.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
      - ./certs/server/mongodb/mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./certs/ca/mongodb/ca.pem:/etc/ssl/ca.pem:ro
    ports:
      - "27018:27017"
    networks:
      - db
    command: mongod --tlsMode requireTLS --tlsCertificateKeyFile /etc/ssl/mongodb.pem --tlsCAFile /etc/ssl/ca.pem --tlsAllowConnectionsWithoutCertificates

  # SSL-enabled Redis for SSL E2E tests
  e2e_redis_ssl:
    profiles: ["ssl"]
    image: redis:latest
    container_name: e2e_redis_ssl
    ports:
      - "6380:6379"
    volumes:
      - e2e_redis_ssl:/data
      - ./certs/server/redis/server-cert.pem:/tls/server-cert.pem:ro
      - ./certs/server/redis/server-key.pem:/tls/server-key.pem:ro
      - ./certs/ca/redis/ca.pem:/tls/ca.pem:ro
      - ./conf/redis_ssl.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - db
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "--cacert", "/tls/ca.pem", "-a", "password", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-ssl-init:
    profiles: ["ssl"]
    image: redis:latest
    depends_on:
      e2e_redis_ssl:
        condition: service_healthy
    volumes:
      - ./sample-data/redis/init.sh:/init.sh:ro
      - ./certs/ca/redis/ca.pem:/certs/ca.pem:ro
    environment:
      REDIS_HOST: e2e_redis_ssl
      REDIS_PORT: "6379"
      REDIS_PASSWORD: password
      REDIS_CACERT: /certs/ca.pem
    entrypoint: ["/bin/sh", "/init.sh"]
    networks:
      - db

  # SSL-enabled ClickHouse for SSL E2E tests
  e2e_clickhouse_ssl:
    profiles: ["ssl"]
    image: clickhouse/clickhouse-server
    container_name: e2e_clickhouse_ssl
    user: clickhouse:clickhouse
    ports:
      - "8443:8443"
      - "9440:9440"
    environment:
      CLICKHOUSE_USER: user
      CLICKHOUSE_PASSWORD: password
      CLICKHOUSE_DB: test_db
      CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS: "true"
    volumes:
      - e2e_clickhouse_ssl:/var/lib/clickhouse
      - ./sample-data/clickhouse/data.sql:/docker-entrypoint-initdb.d/init.sql
      - ./certs/ca/clickhouse/ca.pem:/etc/clickhouse-server/certs/ca.pem:ro
      - ./certs/server/clickhouse/server-cert.pem:/etc/clickhouse-server/certs/server-cert.pem:ro
      - ./certs/server/clickhouse/server-key.pem:/etc/clickhouse-server/certs/server-key.pem:ro
      - ./conf/clickhouse_ssl.xml:/etc/clickhouse-server/config.d/ssl.xml:ro
    networks:
      - db

  # SSL-enabled Elasticsearch for SSL E2E tests
  e2e_elasticsearch_ssl:
    profiles: ["ssl"]
    image: elasticsearch:8.11.1
    container_name: e2e_elasticsearch_ssl
    platform: linux/amd64
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=/usr/share/elasticsearch/config/certs/server-key.pem
      - xpack.security.http.ssl.certificate=/usr/share/elasticsearch/config/certs/server-cert.pem
      - xpack.security.http.ssl.certificate_authorities=/usr/share/elasticsearch/config/certs/ca.pem
      - xpack.security.http.ssl.verification_mode=none
      - xpack.security.transport.ssl.enabled=false
      - ELASTIC_PASSWORD=password
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9201:9200"
    volumes:
      - e2e_elasticsearch_ssl:/usr/share/elasticsearch/data
      - ./certs/ca/elasticsearch/ca.pem:/usr/share/elasticsearch/config/certs/ca.pem:ro
      - ./certs/server/elasticsearch/server-cert.pem:/usr/share/elasticsearch/config/certs/server-cert.pem:ro
      - ./certs/server/elasticsearch/server-key.pem:/usr/share/elasticsearch/config/certs/server-key.pem:ro
    networks:
      db:
        aliases:
          - es-ssl
    healthcheck:
      test: ["CMD-SHELL", "curl -s -k https://localhost:9200/_cluster/health -u elastic:password || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  elasticsearch-ssl-init:
    profiles: ["ssl"]
    image: curlimages/curl:latest
    depends_on:
      e2e_elasticsearch_ssl:
        condition: service_healthy
    volumes:
      - ./sample-data/elasticsearch/upload.sh:/upload.sh:ro
      - ./certs/ca/elasticsearch/ca.pem:/certs/ca.pem:ro
    entrypoint: ["/bin/sh", "-c", "ES_HOST=https://es-ssl:9200 ES_USER=elastic ES_PASS=password ES_CACERT=/certs/ca.pem sh /upload.sh"]
    networks:
      - db

networks:
  db:
    driver: bridge

volumes:
  # e2e_sqlite3:
  e2e_postgres:
  e2e_postgres_ssl:
  e2e_mysql:
  e2e_mysql_ssl:
  e2e_mariadb:
  e2e_mariadb_ssl:
  e2e_mongo:
  e2e_mongo_ssl:
  e2e_clickhouse:
  e2e_clickhouse_ssl:
  e2e_redis:
  e2e_redis_ssl:
  e2e_elasticsearch:
  e2e_elasticsearch_ssl:
  #  e2e_elasticsearch_922:
  e2e_mysql_842:
