name: Build Windows Applications

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      edition:
        description: 'Edition to build (ce or ee)'
        required: false
        type: string
        default: 'ce'
      platforms:
        description: 'Platforms to build (comma-separated: windows-amd64,windows-arm64)'
        required: false
        type: string
        default: 'windows-amd64,windows-arm64'

permissions:
  contents: read
  actions: write

jobs:
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    environment: permission-required
    strategy:
      matrix:
        include:
          - os: windows-latest
            arch: amd64
            make-target: ci-build-prod-windows-amd64
            enabled: ${{ contains(inputs.platforms, 'windows-amd64') }}
          - os: windows-11-arm
            arch: arm64
            make-target: ci-build-prod-windows-arm64
            enabled: ${{ contains(inputs.platforms, 'windows-arm64') }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            proxy.golang.org:443
            storage.googleapis.com:443
            sum.golang.org:443
            registry.npmjs.org:443
            objects.githubusercontent.com:443

      - name: Skip if not enabled
        if: matrix.enabled == false
        run: echo "Skipping windows-${{ matrix.arch }}"

      - name: Checkout
        if: matrix.enabled != false
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Setup Go
        if: matrix.enabled != false
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: 'desktop-${{ inputs.edition }}/go.mod'
          cache: true
          cache-dependency-path: |
            desktop-${{ inputs.edition }}/go.sum
            desktop-${{ inputs.edition }}/go.mod
            core/go.sum
            core/go.mod

      - name: Setup Node.js and pnpm
        if: matrix.enabled != false
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 'lts/*'

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        if: matrix.enabled != false
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        if: matrix.enabled != false
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Install frontend dependencies
        if: matrix.enabled != false
        working-directory: ./frontend
        env:
          CYPRESS_INSTALL_BINARY: "0"
        run: pnpm i

      - name: Install Wails CLI
        if: matrix.enabled != false
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      # Windows AMD64 Build
      - name: Build Windows AMD64
        if: matrix.arch == 'amd64' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        shell: bash
        env:
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ inputs.version }}
        run: |
          echo "Building Windows executable for MSIX packaging..."

          # Prepare frontend
          echo "Preparing frontend..."
          mkdir -p frontend/dist
          cd ../frontend

          # Check if frontend is already built from cache
          if [ -f "build/index.html" ]; then
              echo "Using cached frontend build"
          else
              echo "Building frontend..."
              CYPRESS_INSTALL_BINARY=0 pnpm run build:${{ inputs.edition }}
          fi

          cp -r build/* ../desktop-${{ inputs.edition }}/frontend/dist/
          cd ../desktop-${{ inputs.edition }}

          echo "Using Makefile to build..."
          echo "Building with VERSION=$VERSION"
          make ${{ matrix.make-target }} VERSION="$VERSION"

          # Verify the executable is in the expected location
          if [ -f "build/windows/amd64/whodb.exe" ]; then
              echo "Executable ready: build/windows/amd64/whodb.exe"
          else
              echo "Could not find whodb.exe at expected location"
              exit 1
          fi

      # Windows ARM64 Build
      - name: Build Windows ARM64
        if: matrix.arch == 'arm64' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        shell: bash
        env:
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ inputs.version }}
          CC: clang
          CXX: clang++
          CGO_ENABLED: 1
        run: |
          echo "Building Windows executable for ARM64..."

          # Verify clang is available and supports ARM64
          echo "Checking compiler..."
          clang --version
          clang --print-targets | grep -i aarch64 || echo "aarch64 target check done"

          # Prepare frontend
          echo "Preparing frontend..."
          mkdir -p frontend/dist
          cd ../frontend

          # Check if frontend is already built from cache
          if [ -f "build/index.html" ]; then
              echo "Using cached frontend build"
          else
              echo "Building frontend..."
              CYPRESS_INSTALL_BINARY=0 pnpm run build:${{ inputs.edition }}
          fi

          cp -r build/* ../desktop-${{ inputs.edition }}/frontend/dist/
          cd ../desktop-${{ inputs.edition }}

          echo "Using Makefile to build..."
          echo "Building with VERSION=$VERSION CC=$CC"
          make ${{ matrix.make-target }} VERSION="$VERSION"

          # Verify the executable is in the expected location
          if [ -f "build/windows/arm64/whodb.exe" ]; then
              echo "Executable ready: build/windows/arm64/whodb.exe"
          else
              echo "Could not find whodb.exe at expected location"
              exit 1
          fi

      - name: Upload Windows artifacts
        if: matrix.enabled != false
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: desktop-windows-${{ matrix.arch }}
          path: |
            desktop-${{ inputs.edition }}/build/
          retention-days: 1
