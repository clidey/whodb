name: Build Windows Applications

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      edition:
        description: 'Edition to build (ce or ee)'
        required: false
        type: string
        default: 'ce'
      platforms:
        description: 'Platforms to build (comma-separated: windows-amd64,windows-arm64)'
        required: false
        type: string
        default: 'windows-amd64'

permissions:
  contents: read
  actions: write

jobs:
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    environment: permission-required
    strategy:
      matrix:
        include:
          - os: windows-latest
            arch: amd64
            make-target: ci-build-prod-windows-amd64
            enabled: ${{ contains(inputs.platforms, 'windows-amd64') }}
          - os: windows-11-arm
            arch: arm64
            make-target: ci-build-prod-windows-arm64
            enabled: ${{ contains(inputs.platforms, 'windows-arm64') }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            app.posthog.com:443
            deb.debian.org:443
            deb.debian.org:80
            github.com:443
            objects.githubusercontent.com:443
            proxy.golang.org:443
            registry.npmjs.org:443
            storage.googleapis.com:443
            sum.golang.org:443
            us.i.posthog.com:443
            us.posthog.com:443

      - name: Skip if not enabled
        if: matrix.enabled == false
        run: echo "Skipping windows-${{ matrix.arch }}"

      - name: Checkout
        if: matrix.enabled != false
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: false

      - name: Setup Go
        if: matrix.enabled != false
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'desktop-${{ inputs.edition }}/go.mod'
          cache: true
          cache-dependency-path: |
            desktop-${{ inputs.edition }}/go.sum
            desktop-${{ inputs.edition }}/go.mod
            core/go.sum
            core/go.mod

      - name: Setup Node.js and pnpm
        if: matrix.enabled != false
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 'lts/*'

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        if: matrix.enabled != false
        with:
          version: 10.29.3
          run_install: false

      - name: Get pnpm store directory
        if: matrix.enabled != false
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Install frontend dependencies
        if: matrix.enabled != false
        working-directory: ./frontend
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: pnpm i

      - name: Build frontend
        if: matrix.enabled != false
        working-directory: ./frontend
        run: pnpm run build:${{ inputs.edition }}

      # Upload source maps to PostHog for desktop error tracking
      # Only runs on amd64 to avoid duplicate uploads
      - name: Upload source maps to PostHog
        if: matrix.arch == 'amd64' && matrix.enabled != false
        uses: PostHog/upload-source-maps@991172e085213c222c61d2ba6a0b9e57c81e5066 # v2.0.0
        with:
          directory: frontend/build
          project-id: ${{ secrets.POSTHOG_PROJECT_ID }}
          api-key: ${{ secrets.POSTHOG_API_KEY }}
          release-version: ${{ inputs.version }}
          delete-after-upload: true
        continue-on-error: true

      - name: Install Wails CLI
        if: matrix.enabled != false
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      # Windows AMD64 Build
      - name: Build Windows AMD64
        if: matrix.arch == 'amd64' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        shell: pwsh
        env:
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ inputs.version }}
        run: |
          Write-Host "Building Windows executable for MSIX packaging..."
          Write-Host "Building with VERSION=$env:VERSION"

          make ${{ matrix.make-target }} VERSION="$env:VERSION"

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Make build failed with exit code: $LASTEXITCODE"
              exit 1
          }

          # Verify the executable is in the expected location
          if (Test-Path "build/windows/amd64/whodb.exe") {
              Write-Host "Executable ready: build/windows/amd64/whodb.exe"
          } else {
              Write-Error "Could not find whodb.exe at expected location"
              exit 1
          }

      # Windows ARM64 Build (temporarily disabled)
      - name: Skip Windows ARM64 Build
        if: matrix.arch == 'arm64' && matrix.enabled != false
        shell: pwsh
        run: |
          Write-Host "Windows ARM64 build is temporarily disabled due to toolchain issues"
          New-Item -ItemType Directory -Force -Path "./desktop-${{ inputs.edition }}/build/windows/arm64"

      - name: Upload Windows artifacts
        if: matrix.enabled != false && (matrix.arch != 'arm64')
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: desktop-windows-${{ matrix.arch }}
          path: |
            desktop-${{ inputs.edition }}/build/
          retention-days: 1
