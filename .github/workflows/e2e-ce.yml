name: E2E Tests (CE)

# Runs Playwright E2E tests against all CE databases daily.
# Uses Docker Compose for database services and the existing dev/run-e2e.sh orchestration.

on:
  schedule:
    # Run once a day at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: read

jobs:
  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: core/go.mod

      - name: Setup PNPM
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.29.3
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*

      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install

      - name: Install Playwright browsers
        working-directory: frontend
        run: pnpm exec playwright install --with-deps chromium

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y sqlite3 netcat-openbsd

      - name: Verify Docker Compose
        run: docker compose version

      - name: Create frontend build placeholder
        run: mkdir -p core/build && echo '<!doctype html>' > core/build/index.html

      - name: Run E2E tests
        working-directory: frontend
        run: pnpm e2e:ce:headless

      - name: Upload HTML report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: frontend/e2e/reports/html/
          retention-days: 30

      - name: Upload test logs
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: ${{ !cancelled() }}
        with:
          name: e2e-logs
          path: frontend/e2e/logs/
          retention-days: 7