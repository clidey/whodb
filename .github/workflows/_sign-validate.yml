name: Sign and Validate Builds

on:
  workflow_call:
    inputs:
      version:
        description: 'Version being signed'
        required: true
        type: string
      validate-snap:
        description: 'Whether to validate Snap builds'
        required: false
        type: boolean
        default: true
      validate-desktop:
        description: 'Whether to validate Desktop builds'
        required: false
        type: boolean
        default: true
      validate-appimage:
        description: 'Whether to validate AppImage builds'
        required: false
        type: boolean
        default: true

jobs:
  sign-with-sigstore:
    name: Sign with Sigstore
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Download Snap packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: snap-package-*
          path: artifacts/

      - name: Download Desktop builds
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: desktop-*
          path: artifacts/

      - name: Download AppImages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: appimage-*
          path: artifacts/

      - name: Restore executable permissions
        run: |
          echo "Restoring executable permissions for AppImages..."
          find artifacts -name "*.AppImage" -type f -exec chmod +x {} \;
          echo "âœ… Permissions restored"

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign artifacts
        run: |
          echo "ðŸ” Signing artifacts with Sigstore..."

          # Find all artifacts to sign (excluding Docker .tar files)
          find artifacts -type f \( -name "*.snap" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.dmg" -o -name "*.pkg" -o -name "*.msix" -o -name "*.msixbundle" \) | while read -r file; do
            echo "Signing: $file"

            # Sign the artifact using bundle format (modern cosign approach)
            cosign sign-blob --yes \
              --bundle "${file}.bundle" \
              "$file"

            echo "âœ… Signed: $(basename "$file")"
          done

      - name: Create signatures archive
        run: |
          mkdir -p signatures
          find artifacts -name "*.bundle" | while read -r file; do
            cp "$file" signatures/
          done
          tar czf signatures.tar.gz signatures/

      - name: Upload signatures
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: signatures
          path: signatures.tar.gz
          retention-days: 7

  validate-builds:
    name: Validate All Builds
    runs-on: ubuntu-latest
    needs: [ sign-with-sigstore ]
    permissions:
      contents: read
    steps:
      - name: Checkout for scripts
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Download Snap packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: snap-package-*
          path: artifacts/

      - name: Download Desktop builds
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: desktop-*
          path: artifacts/

      - name: Download AppImages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: appimage-*
          path: artifacts/

      - name: Restore executable permissions
        run: |
          echo "Restoring executable permissions for AppImages..."
          find artifacts -name "*.AppImage" -type f -exec chmod +x {} \;
          echo "âœ… Permissions restored"

      - name: Download signatures
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: signatures
          path: .

      - name: Extract signatures
        run: tar xzf signatures.tar.gz

      - name: Install Cosign for verification
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Validate Snap artifacts
        if: inputs.validate-snap
        run: |
          echo "ðŸ“¦ Validating Snap artifacts..."
          FAILED=false

          for arch in amd64 arm64; do
            ARTIFACT_DIR="artifacts/snap-package-${arch}"
            if [ -d "$ARTIFACT_DIR" ]; then
              SNAP_FILE=$(find "$ARTIFACT_DIR" -name "*.snap" | head -1)
              if [ -n "$SNAP_FILE" ]; then
                echo "âœ… Found Snap ${arch} package: $(basename "$SNAP_FILE")"

                # Verify filename contains correct version
                SNAP_NAME=$(basename "$SNAP_FILE")
                VERSION="${{ inputs.version }}"
                VERSION_NO_V="${VERSION#v}"  # Remove leading 'v' if present

                if [[ "$SNAP_NAME" == *"_${VERSION}_"* ]] || [[ "$SNAP_NAME" == *"_${VERSION_NO_V}_"* ]]; then
                  echo "âœ… Snap filename contains correct version: $VERSION"
                else
                  echo "::error::Snap filename doesn't contain expected version $VERSION"
                  echo "::error::Found: $SNAP_NAME"
                  FAILED=true
                fi
              else
                echo "âŒ Snap ${arch} package missing"
                FAILED=true
              fi
            else
              echo "âŒ Snap ${arch} artifact directory missing"
              FAILED=true
            fi
          done

          if [ "$FAILED" = "true" ]; then
            echo "::error::Snap validation failed"
            exit 1
          fi

      - name: Validate Desktop artifacts
        if: inputs.validate-desktop
        run: |
          echo "ðŸ–¥ï¸ Validating Desktop artifacts..."
          FAILED=false

          # Check Windows builds
          if [ -d "artifacts/desktop-windows-amd64" ]; then
            echo "âœ… Windows AMD64 desktop build found"
          else
            echo "âš ï¸ Windows AMD64 desktop build missing (may be expected)"
          fi

          # Check macOS builds
          if [ -d "artifacts/desktop-darwin-universal" ]; then
            if [ -f "artifacts/desktop-darwin-universal/build/darwin/universal/whodb.dmg" ]; then
              echo "âœ… macOS DMG found"
            else
              echo "âŒ macOS DMG missing"
              FAILED=true
            fi
          else
            echo "âš ï¸ macOS desktop build missing (may be expected)"
          fi

          if [ "$FAILED" = "true" ]; then
            echo "::error::Desktop validation failed"
            exit 1
          fi

      - name: Validate AppImage artifacts
        if: inputs.validate-appimage
        run: |
          echo "ðŸ§ Validating AppImage artifacts..."
          FAILED=false

          for arch in amd64 arm64; do
            ARTIFACT_DIR="artifacts/appimage-ce-${arch}"
            if [ -d "$ARTIFACT_DIR" ]; then
              APPIMAGE_FILE=$(find "$ARTIFACT_DIR" -name "*.AppImage" | head -1)
              if [ -n "$APPIMAGE_FILE" ]; then
                echo "âœ… Found AppImage ${arch}: $(basename "$APPIMAGE_FILE")"

                # Verify signature
                SIG_FILE="signatures/$(basename "$APPIMAGE_FILE").sig"
                CERT_FILE="signatures/$(basename "$APPIMAGE_FILE").pem"
                if [ -f "$SIG_FILE" ] && [ -f "$CERT_FILE" ]; then
                  echo "Verifying signature..."
                  cosign verify-blob \
                    --signature "$SIG_FILE" \
                    --certificate "$CERT_FILE" \
                    --certificate-identity-regexp ".*" \
                    --certificate-oidc-issuer-regexp ".*" \
                    "$APPIMAGE_FILE"
                  echo "âœ… Signature verified"
                else
                  echo "âš ï¸ No signature found for AppImage ${arch}"
                fi

                # Verify it's executable
                if [ -x "$APPIMAGE_FILE" ]; then
                  echo "âœ… AppImage is executable"
                else
                  echo "âŒ AppImage is not executable"
                  FAILED=true
                fi
              else
                echo "âŒ AppImage ${arch} missing"
                FAILED=true
              fi
            else
              echo "âŒ AppImage ${arch} artifact directory missing"
              FAILED=true
            fi
          done

          if [ "$FAILED" = "true" ]; then
            echo "::error::AppImage validation failed"
            exit 1
          fi

      - name: Create validation manifest
        run: |
          cat > validation_manifest.json <<EOF
          {
            "version": "${{ inputs.version }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "validation": {
              "snap": ${{ inputs.validate-snap }},
              "desktop": ${{ inputs.validate-desktop }},
              "appimage": ${{ inputs.validate-appimage }}
            },
            "artifacts": $(find artifacts -type f -name "*.snap" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.dmg" | wc -l)
          }
          EOF

      - name: Upload validation manifest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: deployment-manifest-validated
          path: validation_manifest.json
          retention-days: 1