name: Deploy Homebrew Cask

on:
  workflow_call:
    inputs:
      version:
        description: 'Version being deployed'
        required: true
        type: string

permissions:
  contents: read
  actions: write

jobs:
  generate-homebrew-cask:
    name: Generate Homebrew Cask
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: block
          allowed-endpoints: >
            deb.debian.org:443
            deb.debian.org:80
            github.com:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: false

      - name: Download macOS DMG
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: desktop-darwin-dmg
          path: desktop-builds/

      - name: Generate Homebrew cask file
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ inputs.version }}"

          # Find DMG file
          DMG_PATH=$(find desktop-builds -name "*.dmg" | head -1)

          if [ -z "$DMG_PATH" ]; then
            echo "âŒ No DMG file found"
            exit 1
          fi

          # Generate cask using script
          .github/scripts/generate-homebrew-cask.sh "$VERSION" "$DMG_PATH" whodb.rb

      - name: Upload cask file as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: homebrew-cask
          path: whodb.rb
          retention-days: 30

      - name: Create cask update instructions
        run: |
          VERSION="${{ inputs.version }}"

          cat > HOMEBREW_UPDATE.md <<EOF
          # Homebrew Cask Update Instructions

          The cask file has been generated for WhoDB v${VERSION}.

          ## To submit to Homebrew:

          1. Fork the homebrew-cask repository
          2. Create a new branch: \`update-whodb-${VERSION}\`
          3. Replace the contents of \`Casks/whodb.rb\` with the generated file
          4. Commit with message: \`Update WhoDB to ${VERSION}\`
          5. Submit a pull request

          ## Manual Installation:

          Users can install this version directly:
          \`\`\`bash
          brew install --cask whodb.rb
          \`\`\`
          EOF

          echo "ðŸ“‹ Update instructions generated"
          cat HOMEBREW_UPDATE.md

      - name: Upload instructions
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: homebrew-instructions
          path: HOMEBREW_UPDATE.md
          retention-days: 30