name: Deploy Homebrew Cask

on:
  workflow_call:
    inputs:
      version:
        description: 'Version being deployed'
        required: true
        type: string

permissions:
  contents: read
  actions: write

jobs:
  generate-homebrew-cask:
    name: Generate Homebrew Cask
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Download macOS DMG
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: desktop-darwin-dmg
          path: desktop-builds/

      - name: Generate Homebrew cask file
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ inputs.version }}"

          # Find DMG file
          DMG_PATH=$(find desktop-builds -name "*.dmg" | head -1)

          if [ -z "$DMG_PATH" ]; then
            echo "âŒ No DMG file found"
            exit 1
          fi

          # Generate cask using script
          .github/scripts/generate-homebrew-cask.sh "$VERSION" "$DMG_PATH" whodb.rb

      - name: Upload cask file as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: homebrew-cask
          path: whodb.rb
          retention-days: 30

      - name: Create cask update instructions
        run: |
          VERSION="${{ inputs.version }}"

          cat > HOMEBREW_UPDATE.md <<EOF
          # Homebrew Cask Update Instructions

          The cask file has been generated for WhoDB v${VERSION}.

          ## To submit to Homebrew:

          1. Fork the homebrew-cask repository
          2. Create a new branch: \`update-whodb-${VERSION}\`
          3. Replace the contents of \`Casks/whodb.rb\` with the generated file
          4. Commit with message: \`Update WhoDB to ${VERSION}\`
          5. Submit a pull request

          ## Manual Installation:

          Users can install this version directly:
          \`\`\`bash
          brew install --cask whodb.rb
          \`\`\`
          EOF

          echo "ðŸ“‹ Update instructions generated"
          cat HOMEBREW_UPDATE.md

      - name: Upload instructions
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: homebrew-instructions
          path: HOMEBREW_UPDATE.md
          retention-days: 30