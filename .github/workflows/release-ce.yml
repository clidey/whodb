name: Release CE

# Release workflow for WhoDB Community Edition
#
# Modes:
#   - stage-only: Deploys to edge/draft channels (for testing)
#   - production: Deploys to stable/production channels (for users)
#
# Store Selection:
#   - Works in BOTH modes - select which stores to deploy to
#   - Can deploy to all stores or just specific ones
#   - Stage deploys to: Docker (tag only), Snap (edge), MS Store (draft), Apple (TestFlight)
#   - Production deploys to: Docker (latest), Snap (stable), MS Store (prod), Apple (App Store)

on:
  pull_request:
    types: [ closed ]
    branches: [ release ]
  workflow_dispatch:
    inputs:
      deployment-mode:
        description: 'Deployment Mode'
        required: true
        type: choice
        default: 'stage-only'
        options:
          - 'stage-only'     # Deploy selected stores to edge/draft channels
          - 'production'     # Deploy selected stores to stable/production channels
      version-bump:
        description: 'Version Bump Type'
        required: true
        type: choice
        default: 'minor'
        options:
          - 'major'          # 1.0.0 -> 2.0.0
          - 'minor'          # 0.61.0 -> 0.62.0
          - 'patch'          # 0.61.0 -> 0.61.1
          - 'current'        # Use current version (rebuild without increment)
      # Store selection (applies to both stage and production modes)
      deploy-docker:
        description: 'Deploy to Docker Hub'
        required: false
        type: boolean
        default: false
      deploy-snap:
        description: 'Deploy to Snap Store'
        required: false
        type: boolean
        default: false
      deploy-microsoft:
        description: 'Deploy to Microsoft Store'
        required: false
        type: boolean
        default: false
      deploy-apple:
        description: 'Deploy to Apple App Store'
        required: false
        type: boolean
        default: false
      # DISABLED: AppImage requires system WebKit2GTK - not truly portable
      # deploy-appimage:
      #   description: 'Build AppImage (for GitHub Release)'
      #   required: false
      #   type: boolean
      #   default: false
      deploy-linux-terminal:
        description: 'Build Linux terminal binaries (amd64, arm64, riscv64, armv6, armv7)'
        required: false
        type: boolean
        default: false
      publish-github-release:
        description: 'Publish GitHub release to production (leave unchecked to keep as draft)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: write
  id-token: write

jobs:
  # Step 1: Calculate version and deployment parameters
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'release')
    outputs:
      version: ${{ steps.calc.outputs.version }}
      previous-version: ${{ steps.calc.outputs.previous-version }}
      deployment-mode: ${{ steps.calc.outputs.deployment-mode }}
      stage-only: ${{ steps.calc.outputs.stage-only }}
      deploy-docker: ${{ steps.calc.outputs.deploy-docker }}
      deploy-snap: ${{ steps.calc.outputs.deploy-snap }}
      deploy-microsoft: ${{ steps.calc.outputs.deploy-microsoft }}
      deploy-apple: ${{ steps.calc.outputs.deploy-apple }}
      # deploy-appimage: ${{ steps.calc.outputs.deploy-appimage }}  # DISABLED
      deploy-linux-terminal: ${{ steps.calc.outputs.deploy-linux-terminal }}
      publish-github-release: ${{ steps.calc.outputs.publish-github-release }}
      release-notes: ${{ steps.release_notes.outputs.notes }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          submodules: false

      - name: Determine deployment mode and version bump
        id: deployment_mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.deployment-mode }}"
            VERSION_BUMP="${{ inputs.version-bump || 'minor' }}"
          else
            # PR merges to release branch are always production with minor bump
            MODE="production"
            VERSION_BUMP="minor"
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT

      - name: Calculate version and parameters
        id: calc
        uses: ./.github/actions/calculate-version
        with:
          deployment-mode: ${{ steps.deployment_mode.outputs.mode }}
          version-bump: ${{ steps.deployment_mode.outputs.version_bump }}
          deploy-docker: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.deploy-docker) && 'true' || 'false') }}
          deploy-snap: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.deploy-snap) && 'true' || 'false') }}
          deploy-microsoft: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.deploy-microsoft) && 'true' || 'false') }}
          deploy-apple: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.deploy-apple) && 'true' || 'false') }}
          deploy-appimage: 'false'  # DISABLED: AppImage requires system WebKit2GTK
          deploy-linux-terminal: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.deploy-linux-terminal) && 'true' || 'false') }}
          publish-github-release: ${{ github.event_name == 'pull_request' && 'true' || (fromJSON(inputs.publish-github-release) && 'true' || 'false') }}

      - name: Extract release notes from PR
        id: release_notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NOTES=""

          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "Extracting release notes from PR #$PR_NUMBER..."

            # Get PR body using gh cli
            NOTES=$(gh pr view "$PR_NUMBER" --json body --jq '.body // empty')

            if [ -n "$NOTES" ]; then
              echo "Found release notes from PR description"
            fi
          fi

          # Default if no notes found
          if [ -z "$NOTES" ]; then
            NOTES="Bug fixes and performance improvements."
            echo "Using default release notes"
          fi

          # Output using heredoc for multiline support
          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Display configuration
        run: |
          echo "# ðŸŽ¯ Release Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.calc.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mode** | ${{ steps.calc.outputs.deployment-mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage Only** | ${{ steps.calc.outputs.stage-only }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Publish GitHub Release** | ${{ steps.calc.outputs.publish-github-release }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Targets" >> $GITHUB_STEP_SUMMARY

          MODE="${{ steps.calc.outputs.deployment-mode }}"
          if [ "$MODE" = "production" ]; then
            echo "| Store | Deploy | Channel |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Hub | ${{ steps.calc.outputs.deploy-docker }} | latest |" >> $GITHUB_STEP_SUMMARY
            echo "| Snap Store | ${{ steps.calc.outputs.deploy-snap }} | stable |" >> $GITHUB_STEP_SUMMARY
            echo "| Microsoft Store | ${{ steps.calc.outputs.deploy-microsoft }} | production |" >> $GITHUB_STEP_SUMMARY
            echo "| Apple App Store | ${{ steps.calc.outputs.deploy-apple }} | App Store |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Store | Deploy | Channel |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Hub | ${{ steps.calc.outputs.deploy-docker }} | version tag |" >> $GITHUB_STEP_SUMMARY
            echo "| Snap Store | ${{ steps.calc.outputs.deploy-snap }} | edge |" >> $GITHUB_STEP_SUMMARY
            echo "| Microsoft Store | ${{ steps.calc.outputs.deploy-microsoft }} | draft |" >> $GITHUB_STEP_SUMMARY
            echo "| Apple App Store | ${{ steps.calc.outputs.deploy-apple }} | TestFlight |" >> $GITHUB_STEP_SUMMARY
          fi

  # Step 2: Build artifacts in parallel (only what's selected)
  build-docker:
    name: Build Docker
    needs: [ calculate-version ]
    if: needs.calculate-version.outputs.deploy-docker == 'true'
    uses: ./.github/workflows/_build-docker.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      edition: 'ce'
    secrets: inherit

  build-windows:
    name: Build Windows
    needs: [ calculate-version ]
    if: needs.calculate-version.outputs.deploy-microsoft == 'true'
    uses: ./.github/workflows/_build-windows.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      edition: 'ce'
      platforms: 'windows-amd64,windows-arm64'
    secrets: inherit

  build-apple:
    name: Build Apple
    needs: [ calculate-version ]
    if: needs.calculate-version.outputs.deploy-apple == 'true'
    uses: ./.github/workflows/_build-apple.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      edition: 'ce'
    secrets: inherit

  build-snap:
    name: Build Snap
    needs: [ calculate-version ]
    if: needs.calculate-version.outputs.deploy-snap == 'true'
    uses: ./.github/workflows/_build-snap.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
    secrets: inherit

  # DISABLED: AppImage requires system WebKit2GTK - not truly portable
  # build-appimage:
  #   name: Build AppImage
  #   needs: [ calculate-version ]
  #   if: needs.calculate-version.outputs.deploy-appimage == 'true'
  #   uses: ./.github/workflows/_build-appimage.yml
  #   with:
  #     version: ${{ needs.calculate-version.outputs.version }}
  #     edition: 'ce'
  #   secrets: inherit

  build-linux-terminal:
    name: Build Linux Terminal
    needs: [ calculate-version ]
    if: needs.calculate-version.outputs.deploy-linux-terminal == 'true'
    uses: ./.github/workflows/_build-linux-terminal.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
    secrets: inherit

  # Step 3: Sign and validate all builds (best effort - continues even if any build fails)
  sign-and-validate:
    name: Sign and Validate
    needs: [ calculate-version, build-docker, build-windows, build-apple, build-snap, build-linux-terminal ]
    if: |
      always() &&
      needs.calculate-version.result == 'success' &&
      (needs.build-docker.result == 'success' || needs.build-docker.result == 'skipped' || needs.build-docker.result == 'failure') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped' || needs.build-windows.result == 'failure') &&
      (needs.build-apple.result == 'success' || needs.build-apple.result == 'skipped' || needs.build-apple.result == 'failure') &&
      (needs.build-snap.result == 'success' || needs.build-snap.result == 'skipped' || needs.build-snap.result == 'failure') &&
      (needs.build-linux-terminal.result == 'success' || needs.build-linux-terminal.result == 'skipped' || needs.build-linux-terminal.result == 'failure')
    uses: ./.github/workflows/_sign-validate.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      validate-snap: ${{ needs.build-snap.result == 'success' }}
      validate-desktop: ${{ needs.build-windows.result == 'success' || needs.build-apple.result == 'success' }}
      validate-appimage: false  # DISABLED: AppImage builds disabled

  # Step 4: Create GitHub release (only if ALL selected platforms built successfully)
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [ calculate-version, build-docker, build-windows, build-apple, build-snap, build-linux-terminal, sign-and-validate ]
    if: |
      always() &&
      needs.calculate-version.result == 'success' &&
      needs.sign-and-validate.result == 'success' &&
      (needs.calculate-version.outputs.deploy-docker != 'true' || needs.build-docker.result == 'success') &&
      (needs.calculate-version.outputs.deploy-snap != 'true' || needs.build-snap.result == 'success') &&
      (needs.calculate-version.outputs.deploy-microsoft != 'true' || needs.build-windows.result == 'success') &&
      (needs.calculate-version.outputs.deploy-apple != 'true' || needs.build-apple.result == 'success') &&
      (needs.calculate-version.outputs.deploy-linux-terminal != 'true' || needs.build-linux-terminal.result == 'success')
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Download Snap packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: snap-package-*
          path: artifacts/

      - name: Download Desktop builds
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: desktop-*
          path: artifacts/

      # DISABLED: AppImage builds disabled
      # - name: Download AppImages
      #   uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      #   continue-on-error: true
      #   with:
      #     pattern: appimage-*
      #     path: artifacts/

      - name: Download Linux server binaries
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          pattern: server-binaries-*
          path: artifacts/

      - name: Download signatures
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          name: signatures
          path: artifacts/signatures/

      - name: Prepare release assets
        run: |
          mkdir -p final-assets

          # Copy desktop builds (exe, dmg, msixbundle)
          find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.msixbundle" \) -exec cp {} final-assets/ \; 2>/dev/null || true

          # Copy Linux server binaries
          find artifacts -type f -name "whodb-*-linux-*" -exec cp {} final-assets/ \; 2>/dev/null || true

          # Copy signatures (extract and copy only files, not directories)
          if [ -f artifacts/signatures/signatures.tar.gz ]; then
            mkdir -p /tmp/sig-extract
            tar -xzf artifacts/signatures/signatures.tar.gz -C /tmp/sig-extract/
            find /tmp/sig-extract -type f -exec cp {} final-assets/ \; 2>/dev/null || true
            rm -rf /tmp/sig-extract
          fi

          echo "ðŸ“¦ Release assets prepared:"
          ls -la final-assets/ || echo "No assets found"

      - name: Prepare release body
        id: release_body
        env:
          VERSION: ${{ needs.calculate-version.outputs.version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“ Preparing release body from template..."

          # Read the template
          TEMPLATE=$(cat .github/templates/RELEASE_TEMPLATE.md)

          # Get PR description if this was triggered by a PR merge
          PR_DESCRIPTION=""
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_DESCRIPTION=$(gh pr view $PR_NUMBER --json body --jq '.body')
            echo "Using PR #$PR_NUMBER description"
          else
            echo "Not triggered by PR merge - no PR description"
          fi

          # Replace PR description or remove the placeholder
          if [ -n "$PR_DESCRIPTION" ]; then
            # Save PR description to temp file to preserve newlines
            echo "$PR_DESCRIPTION" > /tmp/pr_description.txt

            # Replace version in template
            TEMPLATE="${TEMPLATE//\{\{VERSION\}\}/$VERSION}"

            # Replace PR_DESCRIPTION with actual file content using awk
            awk '
              /{{PR_DESCRIPTION}}/ {
                while ((getline line < "/tmp/pr_description.txt") > 0) {
                  print line
                }
                close("/tmp/pr_description.txt")
                next
              }
              { print }
            ' <<< "$TEMPLATE" > /tmp/release-body.md
          else
            # Replace version and remove PR_DESCRIPTION placeholder
            TEMPLATE="${TEMPLATE//\{\{VERSION\}\}/$VERSION}"
            echo "$TEMPLATE" | sed '/{{PR_DESCRIPTION}}/d' > /tmp/release-body.md
          fi

          echo "âœ… Release body prepared"
          echo "Preview:"
          cat /tmp/release-body.md

      - name: Create GitHub release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: ${{ needs.calculate-version.outputs.version }}
          name: Release ${{ needs.calculate-version.outputs.version }}
          draft: ${{ needs.calculate-version.outputs.stage-only == 'true' || needs.calculate-version.outputs.publish-github-release != 'true' }}
          prerelease: false
          generateReleaseNotes: true
          artifacts: final-assets/*
          bodyFile: /tmp/release-body.md

  # Step 5: Deploy to various platforms (after GitHub release created)
  deploy-snap:
    name: Deploy Snap
    needs: [ calculate-version, create-github-release ]
    if: |
      always() &&
      needs.calculate-version.outputs.deploy-snap == 'true' &&
      needs.create-github-release.result == 'success'
    uses: ./.github/workflows/_deploy-snap.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      channel: ${{ needs.calculate-version.outputs.stage-only == 'true' && 'edge' || 'stable' }}
    secrets: inherit

  deploy-microsoft:
    name: Deploy Microsoft
    needs: [ calculate-version, create-github-release ]
    if: |
      always() &&
      needs.calculate-version.outputs.deploy-microsoft == 'true' &&
      needs.create-github-release.result == 'success'
    uses: ./.github/workflows/_deploy-microsoft.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      stage-only: ${{ needs.calculate-version.outputs.stage-only == 'true' }}
    secrets: inherit

  deploy-apple:
    name: Deploy Apple
    needs: [ calculate-version, create-github-release ]
    if: |
      always() &&
      needs.calculate-version.outputs.deploy-apple == 'true' &&
      needs.create-github-release.result == 'success'
    uses: ./.github/workflows/_deploy-apple.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      stage-only: ${{ needs.calculate-version.outputs.stage-only == 'true' }}
      release-notes: ${{ needs.calculate-version.outputs.release-notes }}
    secrets: inherit

  # Step 6: Deploy to Docker Hub (after GitHub release)
  deploy-docker:
    name: Deploy Docker
    needs: [ calculate-version, create-github-release ]
    if: |
      always() &&
      needs.calculate-version.outputs.deploy-docker == 'true' &&
      needs.create-github-release.result == 'success'
    uses: ./.github/workflows/_deploy-docker.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      stage-only: ${{ needs.calculate-version.outputs.stage-only == 'true' }}
    secrets: inherit

  # Step 7: Generate Homebrew cask (production only)
  generate-homebrew-cask:
    name: Generate Homebrew Cask
    needs: [ calculate-version, create-github-release ]
    if: |
      needs.calculate-version.outputs.stage-only != 'true' &&
      needs.calculate-version.outputs.deployment-mode == 'production' &&
      needs.create-github-release.result == 'success'
    uses: ./.github/workflows/_deploy-homebrew.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}

  # Step 8: Final summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [
      calculate-version,
      build-docker,
      build-windows,
      build-apple,
      build-snap,
      build-linux-terminal,
      sign-and-validate,
      deploy-docker,
      deploy-snap,
      deploy-microsoft,
      deploy-apple,
      create-github-release,
      generate-homebrew-cask
    ]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >+

      - name: Generate comprehensive summary
        run: |
          echo "# ðŸ“Š Release Summary for ${{ needs.calculate-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Mode:** ${{ needs.calculate-version.outputs.deployment-mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build Status
          echo "## ðŸ”¨ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-docker.result }}" = "success" ]; then
            echo "| Docker | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-docker.result }}" = "skipped" ]; then
            echo "| Docker | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            echo "| Windows | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-windows.result }}" = "skipped" ]; then
            echo "| Windows | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Windows | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-apple.result }}" = "success" ]; then
            echo "| Apple | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-apple.result }}" = "skipped" ]; then
            echo "| Apple | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Apple | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-snap.result }}" = "success" ]; then
            echo "| Snap | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-snap.result }}" = "skipped" ]; then
            echo "| Snap | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Snap | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-linux-terminal.result }}" = "success" ]; then
            echo "| Linux Terminal | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-linux-terminal.result }}" = "skipped" ]; then
            echo "| Linux Terminal | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Linux Terminal | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Deployment Status
          echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------|" >> $GITHUB_STEP_SUMMARY

          # Docker Hub
          if [ "${{ needs.deploy-docker.result }}" = "success" ]; then
            echo "| Docker Hub | âœ… Deployed | Latest tag updated |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-docker.result }}" = "skipped" ]; then
            if [ "${{ needs.calculate-version.outputs.stage-only }}" = "true" ]; then
              echo "| Docker Hub | â­ï¸ Skipped | Stage-only mode |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Docker Hub | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Docker Hub | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          # Snap Store
          if [ "${{ needs.deploy-snap.result }}" = "success" ]; then
            CHANNEL="${{ needs.calculate-version.outputs.stage-only == 'true' && 'edge' || 'stable' }}"
            echo "| Snap Store | âœ… Deployed | ${CHANNEL} channel |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-snap.result }}" = "skipped" ]; then
            echo "| Snap Store | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Snap Store | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          # Microsoft Store
          if [ "${{ needs.deploy-microsoft.result }}" = "success" ]; then
            if [ "${{ needs.calculate-version.outputs.stage-only }}" = "true" ]; then
              echo "| Microsoft Store | âœ… Deployed | Draft submission |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Microsoft Store | âœ… Deployed | Submitted for certification |" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ needs.deploy-microsoft.result }}" = "skipped" ]; then
            echo "| Microsoft Store | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Microsoft Store | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          # Apple App Store
          if [ "${{ needs.deploy-apple.result }}" = "success" ]; then
            if [ "${{ needs.calculate-version.outputs.stage-only }}" = "true" ]; then
              echo "| Apple App Store | âœ… Deployed | TestFlight only |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Apple App Store | âœ… Deployed | Submitted for review |" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ needs.deploy-apple.result }}" = "skipped" ]; then
            echo "| Apple App Store | â­ï¸ Skipped | Not selected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Apple App Store | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          # GitHub Release
          if [ "${{ needs.create-github-release.result }}" = "success" ]; then
            if [ "${{ needs.calculate-version.outputs.stage-only }}" = "true" ] || [ "${{ needs.calculate-version.outputs.publish-github-release }}" != "true" ]; then
              RELEASE_NOTE="Draft release"
            else
              RELEASE_NOTE="Published"
            fi
            if [ "${{ needs.calculate-version.outputs.deploy-linux-terminal }}" = "true" ]; then
              RELEASE_NOTE="$RELEASE_NOTE (includes Linux Terminal)"
            fi
            echo "| GitHub Release | âœ… Created | $RELEASE_NOTE |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-github-release.result }}" = "skipped" ]; then
            echo "| GitHub Release | â­ï¸ Skipped | Stage-only mode |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub Release | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          # Homebrew
          if [ "${{ needs.generate-homebrew-cask.result }}" = "success" ]; then
            echo "| Homebrew Cask | âœ… Generated | Formula created |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.generate-homebrew-cask.result }}" = "skipped" ]; then
            echo "| Homebrew Cask | â­ï¸ Skipped | Not production |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Homebrew Cask | âŒ Failed | Check logs |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Next Steps
          echo "## ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.calculate-version.outputs.stage-only }}" = "true" ]; then
            echo "Stage deployments completed. To promote to production:" >> $GITHUB_STEP_SUMMARY
            echo "1. Test the edge/draft releases" >> $GITHUB_STEP_SUMMARY
            echo "2. Promote Snap from edge to stable channel" >> $GITHUB_STEP_SUMMARY
            echo "3. Submit Microsoft Store draft for certification" >> $GITHUB_STEP_SUMMARY
            echo "4. Submit Apple TestFlight build for App Store review" >> $GITHUB_STEP_SUMMARY
            echo "5. Publish GitHub draft release" >> $GITHUB_STEP_SUMMARY
            echo "6. Deploy to Docker Hub" >> $GITHUB_STEP_SUMMARY
          else
            echo "Production deployment completed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Monitor the following:**" >> $GITHUB_STEP_SUMMARY
            echo "- Microsoft Store certification status" >> $GITHUB_STEP_SUMMARY
            echo "- Apple App Store review status" >> $GITHUB_STEP_SUMMARY
            echo "- User feedback on new release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**If any platform failed:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the logs for the failed job" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix the issue" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run the failed job from Actions â†’ Re-run jobs â†’ Re-run failed jobs" >> $GITHUB_STEP_SUMMARY
          fi
