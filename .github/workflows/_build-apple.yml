name: Build Apple Applications

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      edition:
        description: 'Edition to build (ce or ee)'
        required: false
        type: string
        default: 'ce'
      platforms:
        description: 'Platforms to build (comma-separated, e.g., darwin-universal)'
        required: false
        type: string
        default: 'darwin-universal'

permissions:
  contents: read
  actions: write

jobs:
  build-apple:
    name: Build macOS (${{ matrix.build-type }})
    runs-on: macos-latest
    environment: build-apple
    strategy:
      matrix:
        include:
          - build-type: dmg
            make-target: build-prod-mac
            enabled: ${{ contains(inputs.platforms, 'darwin-universal') }}
          - build-type: mas
            make-target: build-prod-mac
            enabled: ${{ contains(inputs.platforms, 'darwin-universal') }}
    steps:
      - name: Skip if not enabled
        if: matrix.enabled == false
        run: echo "Skipping darwin-universal-${{ matrix.build-type }}"

      - name: Checkout
        if: matrix.enabled != false
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Setup Go
        if: matrix.enabled != false
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: 'desktop-${{ inputs.edition }}/go.mod'
          cache: true
          cache-dependency-path: |
            desktop-${{ inputs.edition }}/go.sum
            desktop-${{ inputs.edition }}/go.mod
            core/go.sum
            core/go.mod

      - name: Setup Node.js and pnpm
        if: matrix.enabled != false
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 'lts/*'

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        if: matrix.enabled != false
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        if: matrix.enabled != false
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Install frontend dependencies
        if: matrix.enabled != false
        working-directory: ./frontend
        env:
          CYPRESS_INSTALL_BINARY: "0"
        run: pnpm i

      - name: Install Wails CLI
        if: matrix.enabled != false
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      # Import Apple Developer certificates for macOS DMG signing
      - name: Import Apple Developer Certificates (Developer ID)
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        env:
          CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$CERTIFICATE_P12_BASE64" ]; then
            echo "‚ùå ERROR: Apple certificates are required for macOS builds"
            echo "Please configure APPLE_CERTIFICATES_P12 and APPLE_CERTIFICATES_PASSWORD secrets"
            exit 1
          fi

          if [ -z "$CERTIFICATE_PASSWORD" ]; then
            echo "‚ùå ERROR: APPLE_CERTIFICATES_PASSWORD is required"
            exit 1
          fi

          echo "üîê Setting up keychain for code signing..."

          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD_VALUE="${KEYCHAIN_PASSWORD:-$(uuidgen)}"

          # Decode certificate
          echo "$CERTIFICATE_P12_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import "$CERTIFICATE_PATH" -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # Set keychain search list
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed s/\"//g)

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"

          echo "‚úÖ Certificates imported successfully"

          # List available signing identities for verification
          echo "Available codesigning identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo ""
          echo "Available basic identities (includes installer certs):"
          security find-identity -v -p basic "$KEYCHAIN_PATH"

          echo ""
          echo "All identities in keychain:"
          security find-identity -v "$KEYCHAIN_PATH"

      # Save MAS provisioning profile for later (after build)
      - name: Prepare MAS Provisioning Profile
        if: matrix.build-type == 'mas' && matrix.enabled != false
        env:
          MAS_PROVISIONING_PROFILE: ${{ secrets.APPLE_MAS_PROVISIONING_PROFILE }}
        run: |
          if [ -z "$MAS_PROVISIONING_PROFILE" ]; then
            echo "‚ùå ERROR: APPLE_MAS_PROVISIONING_PROFILE is required for MAS builds"
            exit 1
          fi

          echo "üìù Saving provisioning profile for post-build signing..."
          mkdir -p desktop-${{ inputs.edition }}/build/darwin
          echo "$MAS_PROVISIONING_PROFILE" | base64 --decode -o desktop-${{ inputs.edition }}/build/darwin/embedded.provisionprofile
          echo "‚úÖ Provisioning profile saved"

      - name: Clean previous macOS build
        if: matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          echo "Cleaning previous build to ensure bundle ID changes take effect..."
          rm -rf build/darwin/universal build/darwin/amd64 build/darwin/arm64 build/dmgroot || true
          rm -rf build/bin wails.lock || true
          echo "Template files preserved in build/darwin/"

      - name: Prepare MAS entitlements and provisioning profile
        if: matrix.build-type == 'mas' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          echo "Preparing MAS-specific entitlements..."
          mkdir -p build/darwin
          cp ../.github/templates/entitlements.mas.plist build/darwin/entitlements.plist
          echo "‚úÖ MAS entitlements prepared"

      - name: Verify entitlements before build
        if: matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          echo "Checking for entitlements.plist before build..."
          ls -la build/darwin/ || echo "build/darwin doesn't exist"

          if [ -f build/darwin/entitlements.plist ]; then
            echo "‚úÖ Entitlements exist before build"
          else
            echo "‚ùå Entitlements missing before build"
          fi

      - name: Build macOS
        if: matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: make ${{ matrix.make-target }} VERSION=${{ inputs.version }}

      - name: Verify entitlements after build
        if: matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          echo "Checking for entitlements.plist after build..."
          ls -la build/darwin/ || echo "build/darwin doesn't exist"

          if [ -f build/darwin/entitlements.plist ]; then
            echo "‚úÖ Entitlements exist after build"
          else
            echo "‚ùå Entitlements deleted during build"
            echo "Recreating from source..."
            if [ -f ../../desktop-${{ inputs.edition }}/build/darwin/entitlements.plist ]; then
              cp ../../desktop-${{ inputs.edition }}/build/darwin/entitlements.plist build/darwin/
            fi
          fi

      - name: Patch Bundle ID and Sign (DMG)
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        env:
          APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          APP_PATH="build/darwin/universal/WhoDB.app"

          if [ ! -d "$APP_PATH" ]; then
            echo "‚ùå ERROR: App bundle not found at $APP_PATH"
            exit 1
          fi

          PLIST_PATH="$APP_PATH/Contents/Info.plist"

          # Show original bundle ID
          echo "Original Bundle ID:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST_PATH"

          # Patch bundle ID to match App Store Connect
          echo ""
          echo "Patching bundle ID to com.clidey.whodb..."
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.clidey.whodb" "$PLIST_PATH"

          # Add encryption exemption (only uses standard OS TLS/SSL)
          echo "Adding encryption exemption key..."
          /usr/libexec/PlistBuddy -c "Add :ITSAppUsesNonExemptEncryption bool false" "$PLIST_PATH" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :ITSAppUsesNonExemptEncryption false" "$PLIST_PATH"

          # Verify the changes
          echo "New Bundle ID:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST_PATH"
          echo "Encryption exemption:"
          /usr/libexec/PlistBuddy -c "Print :ITSAppUsesNonExemptEncryption" "$PLIST_PATH"

          # Validate plist is still valid
          plutil -lint "$PLIST_PATH"

          echo ""
          echo "üîè Signing app bundle for DMG distribution with Developer ID..."
          codesign --force --deep \
            --sign "$APPLE_DEVELOPER_ID_APPLICATION" \
            --options runtime \
            --timestamp \
            "$APP_PATH"

          echo "Verifying signature..."
          codesign --verify --verbose=4 "$APP_PATH"

          echo "‚úÖ App patched, signed, and verified for DMG distribution"

      - name: Import MAS Certificates for Signing
        if: matrix.build-type == 'mas' && matrix.enabled != false
        env:
          MAS_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_MAS_CERTIFICATES_P12 }}
          MAS_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_MAS_CERTIFICATES_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$MAS_CERTIFICATE_P12_BASE64" ]; then
            echo "‚ùå ERROR: Mac App Store certificates are required for MAS builds"
            exit 1
          fi

          echo "üîê Setting up keychain for Mac App Store code signing..."

          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/mas_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/mas-signing.keychain-db
          KEYCHAIN_PASSWORD_VALUE="${KEYCHAIN_PASSWORD:-$(uuidgen)}"

          # Decode certificate
          echo "$MAS_CERTIFICATE_P12_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import "$CERTIFICATE_PATH" -P "$MAS_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # Set keychain search list
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed s/\"//g)

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD_VALUE" "$KEYCHAIN_PATH"

          echo "‚úÖ Mac App Store certificates imported successfully"

          # Save MAS certificate name for signing step
          MAS_CERT=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "3rd Party Mac Developer Application" | head -1 | awk '{print $2}')
          echo "MAS_CERT_ID=$MAS_CERT" >> $GITHUB_ENV
          echo "Using certificate: $MAS_CERT"

      - name: Patch Bundle ID, Embed Profile, and Sign (MAS)
        if: matrix.build-type == 'mas' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          APP_PATH="build/darwin/universal/WhoDB.app"

          if [ ! -d "$APP_PATH" ]; then
            echo "‚ùå ERROR: App bundle not found at $APP_PATH"
            exit 1
          fi

          PLIST_PATH="$APP_PATH/Contents/Info.plist"

          # Show original bundle ID
          echo "Original Bundle ID:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST_PATH"

          # Patch bundle ID to match App Store Connect
          echo ""
          echo "Patching bundle ID to com.clidey.whodb..."
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.clidey.whodb" "$PLIST_PATH"

          # Add encryption exemption (only uses standard OS TLS/SSL)
          echo "Adding encryption exemption key..."
          /usr/libexec/PlistBuddy -c "Add :ITSAppUsesNonExemptEncryption bool false" "$PLIST_PATH" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :ITSAppUsesNonExemptEncryption false" "$PLIST_PATH"

          # Add LSApplicationCategoryType
          echo "Adding LSApplicationCategoryType..."
          /usr/libexec/PlistBuddy -c "Add :LSApplicationCategoryType string public.app-category.developer-tools" "$PLIST_PATH" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :LSApplicationCategoryType public.app-category.developer-tools" "$PLIST_PATH"

          # Verify the changes
          echo "New Bundle ID:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST_PATH"
          echo "Encryption exemption:"
          /usr/libexec/PlistBuddy -c "Print :ITSAppUsesNonExemptEncryption" "$PLIST_PATH"

          # Validate plist is still valid
          plutil -lint "$PLIST_PATH"

          # Ensure binary has execute permissions
          echo ""
          echo "üîß Ensuring binary has execute permissions..."
          chmod +x "$APP_PATH/Contents/MacOS/whodb"
          ls -la "$APP_PATH/Contents/MacOS/whodb"

          # Step 1: Embed provisioning profile (per Wails docs)
          echo ""
          echo "üìù Step 1: Embedding provisioning profile..."
          if [ -f "build/darwin/embedded.provisionprofile" ]; then
            cp build/darwin/embedded.provisionprofile "$APP_PATH/Contents/embedded.provisionprofile"
            echo "‚úÖ Provisioning profile embedded at: $APP_PATH/Contents/embedded.provisionprofile"
          else
            echo "‚ùå ERROR: No provisioning profile found"
            exit 1
          fi

          # Step 2: Code sign with MAS certificate (per Wails docs)
          echo ""
          echo "üîè Step 2: Code signing with Mac App Store certificate..."
          echo "Using certificate: $MAS_CERT_ID"
          echo "Using entitlements: build/darwin/entitlements.plist"

          # Sign the app bundle (following Wails documentation approach)
          codesign --force \
            --sign "$MAS_CERT_ID" \
            --entitlements build/darwin/entitlements.plist \
            --options runtime \
            --timestamp \
            "$APP_PATH"

          echo ""
          echo "‚úÖ App signed for Mac App Store"

          # Step 3: Verify signature
          echo ""
          echo "üîç Step 3: Verifying signature..."
          codesign --verify --verbose=4 "$APP_PATH"

          echo ""
          echo "üìã Entitlements:"
          codesign --display --entitlements - "$APP_PATH"

          echo ""
          echo "‚úÖ MAS build complete and verified"

      - name: Create macOS DMG
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: make dmg-mac-only VERSION=${{ inputs.version }}

      - name: Sign and Notarize DMG
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        env:
          APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          # Validate all required credentials
          if [ -z "$APPLE_DEVELOPER_ID_APPLICATION" ]; then
            echo "‚ùå ERROR: APPLE_DEVELOPER_ID_APPLICATION is required"
            exit 1
          fi

          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_PASSWORD" ] || [ -z "$APPLE_TEAM_ID" ]; then
            echo "‚ùå ERROR: APPLE_ID, APPLE_APP_PASSWORD, and APPLE_TEAM_ID are required for notarization"
            exit 1
          fi

          DMG_FILE="build/darwin/universal/whodb.dmg"

          # Sign the DMG with Developer ID
          echo "Signing DMG with Developer ID certificate..."
          codesign --force --sign "$APPLE_DEVELOPER_ID_APPLICATION" \
            --options runtime --timestamp "$DMG_FILE"

          # Notarize
          echo "üì§ Submitting DMG for notarization..."
          xcrun notarytool submit "$DMG_FILE" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          echo "üìé Stapling notarization ticket..."
          xcrun stapler staple "$DMG_FILE"
          echo "‚úÖ DMG signed and notarized"

      - name: Cleanup build artifacts before upload
        if: matrix.enabled != false
        working-directory: ./desktop-${{ inputs.edition }}
        run: |
          echo "Cleaning up intermediate build files..."
          rm -rf build/dmgroot
          rm -rf build/bin
          echo "Remaining files to upload:"
          du -sh build/darwin/universal/* || true

      # Upload DMG artifacts (only for DMG builds)
      - name: Upload macOS DMG
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: desktop-darwin-dmg
          path: desktop-${{ inputs.edition }}/build/darwin/universal/*.dmg
          retention-days: 1

      - name: Upload macOS App Bundle (DMG)
        if: matrix.build-type == 'dmg' && matrix.enabled != false
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: desktop-darwin-app
          path: desktop-${{ inputs.edition }}/build/darwin/universal/*.app
          retention-days: 1

      # Upload MAS artifacts (only for MAS builds)
      - name: Upload macOS App Bundle (MAS)
        if: matrix.build-type == 'mas' && matrix.enabled != false
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: desktop-darwin-mas-app
          path: desktop-${{ inputs.edition }}/build/darwin/universal/*.app
          retention-days: 1

      - name: Upload macOS MAS Entitlements
        if: matrix.build-type == 'mas' && matrix.enabled != false
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: desktop-darwin-entitlements
          path: desktop-${{ inputs.edition }}/build/darwin/entitlements.plist
          retention-days: 1

      # Cleanup keychain
      - name: Cleanup Keychain
        if: always() && matrix.enabled != false
        run: |
          echo "üßπ Cleaning up keychains..."
          # Clean up DMG keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
            echo "‚úÖ DMG keychain cleanup complete"
          fi
          # Clean up MAS keychain
          MAS_KEYCHAIN_PATH=$RUNNER_TEMP/mas-signing.keychain-db
          if [ -f "$MAS_KEYCHAIN_PATH" ]; then
            security delete-keychain "$MAS_KEYCHAIN_PATH" || true
            echo "‚úÖ MAS keychain cleanup complete"
          fi
