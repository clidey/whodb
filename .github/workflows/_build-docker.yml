name: Build Docker Images

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      edition:
        description: 'Edition to build (ce or ee)'
        required: false
        type: string
        default: 'ce'
    outputs:
      amd64-artifact:
        description: 'AMD64 Docker artifact name'
        value: docker-image-amd64
      arm64-artifact:
        description: 'ARM64 Docker artifact name'
        value: docker-image-arm64

permissions:
  contents: read
  actions: write

jobs:
  build-docker:
    name: Build Docker (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    environment: permission-required
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            app.posthog.com:443
            auth.docker.io:443
            deb.debian.org:443
            dl-cdn.alpinelinux.org:443
            github.com:443
            objects.githubusercontent.com:443
            production.cloudflare.docker.com:443
            proxy.golang.org:443
            registry-1.docker.io:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
            storage.googleapis.com:443
            sum.golang.org:443
            us.i.posthog.com:443
            us.posthog.com:443

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 'lts/*'

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      # CACHING DISABLED TO AVOID STALE CACHE ISSUES
      # - name: Setup pnpm cache
      #   uses: actions/cache@v4
      #   with:
      #     path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
      #     key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-pnpm-store-

      # - name: Cache frontend build
      #   id: frontend-cache
      #   uses: actions/cache@v4
      #   with:
      #     path: frontend/build
      #     key: frontend-build-${{ inputs.edition }}-${{ hashFiles('frontend/package.json', 'frontend/pnpm-lock.yaml', 'frontend/tsconfig.json') }}
      #     restore-keys: |
      #       frontend-build-${{ inputs.edition }}-

      - name: Build frontend
        # Always build frontend since cache is disabled
        working-directory: ./frontend
        env:
          CYPRESS_INSTALL_BINARY: "0"
        run: |
          pnpm install
          pnpm run build:${{ inputs.edition }}

      # Upload source maps to PostHog for production error tracking
      # This injects metadata into JS files and uploads .map files
      # Only runs on amd64 to avoid duplicate uploads (frontend is identical across architectures)
      - name: Upload source maps to PostHog
        if: matrix.arch == 'amd64'
        uses: PostHog/upload-source-maps@9588f138ad57fa0471ddcbb0b564a7b584dc8a9a # v0.5.7.0
        with:
          directory: frontend/build
          env-id: ${{ secrets.POSTHOG_ENV_ID }}
          cli-token: ${{ secrets.POSTHOG_CLI_TOKEN }}
          version: ${{ inputs.version }}
          delete-after-upload: true
        continue-on-error: true  # Don't fail build if source map upload fails

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./core/Dockerfile
          platforms: ${{ matrix.platform }}
          push: false
          tags: clidey/whodb:${{ inputs.version }}-${{ matrix.arch }}
          outputs: type=docker,dest=/tmp/whodb-docker-${{ matrix.arch }}.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ inputs.version }}
            PLATFORM=docker

      - name: Upload Docker artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: docker-image-${{ matrix.arch }}
          path: /tmp/whodb-docker-${{ matrix.arch }}.tar
          retention-days: 1