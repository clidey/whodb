name: Build AppImage

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      edition:
        description: 'Edition to build (ce or ee)'
        required: false
        type: string
        default: 'ce'

permissions:
  contents: read
  actions: write

jobs:
  build-appimage:
    name: Build AppImage (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    environment: permission-required
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'desktop-ce/go.mod'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            wget \
            fuse \
            file

      - name: Download frontend build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: frontend-build-${{ inputs.edition }}
          path: frontend/build

      - name: Copy frontend to desktop directory
        run: |
          mkdir -p desktop-${{ inputs.edition }}/frontend/dist
          cp -r frontend/build/* desktop-${{ inputs.edition }}/frontend/dist/

      # - name: Cache Wails binary
      #   id: cache-wails
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/go/bin/wails
      #     key: ${{ runner.os }}-${{ runner.arch }}-wails-v2.10.2

      - name: Set up Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Determine Go workspace
        id: gowork
        run: |
          if [ "${{ inputs.edition }}" = "ee" ]; then
            echo "workspace=$PWD/ee/go.work.desktop" >> $GITHUB_OUTPUT
            echo "source_dir=ee/desktop" >> $GITHUB_OUTPUT
          else
            echo "workspace=$PWD/go.work.desktop-ce" >> $GITHUB_OUTPUT
            echo "source_dir=desktop-ce" >> $GITHUB_OUTPUT
          fi

      - name: Build Wails app for ${{ matrix.arch }}
        run: |
          cd ${{ steps.gowork.outputs.source_dir }}

          # Use make ci-build-prod-linux which handles webkit2_41 tags
          # Frontend is already built and copied to frontend/dist
          TARGET_ARCH=${{ matrix.arch }} make ci-build-prod-linux VERSION=${{ inputs.version }}

      - name: Build AppImage
        run: |
          chmod +x .github/scripts/build-appimage.sh
          ./.github/scripts/build-appimage.sh ${{ matrix.arch }} ${{ inputs.version }}

      - name: Verify AppImage
        run: |
          APPIMAGE="WhoDB-${{ inputs.version }}-${{ matrix.arch }}.AppImage"

          if [ ! -f "$APPIMAGE" ]; then
            echo "❌ AppImage not found: $APPIMAGE"
            exit 1
          fi

          chmod +x "$APPIMAGE"
          echo "✅ AppImage created: $APPIMAGE"
          ls -lh "$APPIMAGE"
          file "$APPIMAGE"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: appimage-${{ inputs.edition }}-${{ matrix.arch }}
          path: WhoDB-${{ inputs.version }}-${{ matrix.arch }}.AppImage
          retention-days: 1
